#!/bin/csh -f

set path = ($MIRBIN $path)

# Get the name of the machine we are running on.

set noupdate = 0
set base = $1
if ( "$1" == "-noupdate" ) then
  set noupdate = 1
  set base = $2
endif
  
if ( "$base" == "") then
  echo "  Usage:"
  echo "    mirimport [-noupdate] site-name"
  exit
endif

# Move to the import directory.

if ( ! -e $MIR/import ) mkdir $MIR/import
cd $MIR/import
if ( $status ) then
  echo "### Fatal: Failed to cd to $MIR/import
  exit 1
endif

# Get the updates.

echo -n "Starting to ftp ... "
ftp -in << END_OF_FILE >& /dev/null
open atnf.csiro.au
user ftp rsault@atnf.csiro.au
cd /pub/software/miriad/updates
binary
mget ${base}_\*.tar.Z
quit
END_OF_FILE
if ( $status ) exit
echo "done"

# Check for files.

  ls ${base}_*.tar.Z >& /dev/null
  if ( $status ) then
    echo "### Fatal: No updates found"
    exit 1
  endif

# Process the updates.

foreach file ( ${base}_*.tar.Z )
  echo Untarred $file at `date`
  zcat $file | ( cd $MIR; tar -xvmf - )
  set stat1 = $status
  if ( $stat1 == 141 ) then
    echo "### Warning: Untarring ended with status=$stat1"
  else if ( $stat1 ) then
    echo "### Fatal: Failed to successfully untar - status=$stat1"
    exit 1
  endif
  echo Untarred $file at `date` > ${file}.Done
  ftp -in << END_OF_FILE
open atnf.csiro.au
user ftp rsault@atnf.csiro.au
cd /pub/software/miriad/updates
put ${file}.Done
quit
END_OF_FILE
  rm -r $file ${file}.Done
end

if ( $noupdate ) exit
echo y | mirupdate
